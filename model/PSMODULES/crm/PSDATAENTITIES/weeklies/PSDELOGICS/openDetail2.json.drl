package cn.ibizlab.crm.crm.logic.weeklieslogic.opendetail2;
        import java.util.Map;
        import java.util.HashMap;
        import com.alibaba.fastjson.JSONObject;
        import org.springframework.util.StringUtils;
        import org.springframework.util.ObjectUtils;
        import cn.ibizlab.crm.util.errors.BadRequestAlertException;
                global cn.ibizlab.crm.core.crm.domain.weeklies weekliesopendetail2default;
                global cn.ibizlab.crm.core.crm.domain.task weekliesopendetail2activities;
                global cn.ibizlab.crm.core.crm.domain.note_attach weekliesopendetail2notes;
                global cn.ibizlab.crm.core.crm.domain.task weekliesopendetail2tasks;
        global cn.ibizlab.crm.core.crm.service.IweekliesService iBzSysWeekliesDefaultService;
        global cn.ibizlab.crm.util.security.AuthenticationUser curuser;


    no-loop

            //逻辑处理节点[开始]
            rule "begin"
            ruleflow-group "weekliesopendetail2begin"
            when
            then
            end

            //逻辑处理节点[调试逻辑参数]
            rule "debugparam1"
            ruleflow-group "weekliesopendetail2debugparam1"
            when
            then
                        update(weekliesopendetail2default);//更新fact中变量值
                        update(weekliesopendetail2activities);//更新fact中变量值
                        update(weekliesopendetail2notes);//更新fact中变量值
                        update(weekliesopendetail2tasks);//更新fact中变量值
            end

            //逻辑处理节点[结束]
            rule "end1"
            ruleflow-group "weekliesopendetail2end1"
            when
            then
                        update(weekliesopendetail2default);//更新fact中变量值
                        update(weekliesopendetail2activities);//更新fact中变量值
                        update(weekliesopendetail2notes);//更新fact中变量值
                        update(weekliesopendetail2tasks);//更新fact中变量值
            end

            //逻辑处理节点[本周活动]
            rule "rawsqlcall1"
            ruleflow-group "weekliesopendetail2rawsqlcall1"
            when
            then
    Map param =new HashMap();
        param.put("param0",weekliesopendetail2default.get("createman"));
        param.put("param1",weekliesopendetail2default.get("owner"));
        param.put("param2",weekliesopendetail2default.get("startdate"));
        param.put("param3",weekliesopendetail2default.get("enddate"));
    String strSql="select 	ID as TARGET_ID, 	SUBJECT  as NAME, 	'MANEUVER' as TARGET_TYPE,     START_TIME,     PRIORITY,     STATUS,     COST,     DESCRIPTION  from 	TASK where 	`TYPE` = 'MANEUVER' 	and (CREATE_MAN = #{et.param0} 		or OWNER = #{et.param1})     AND START_TIME >= #{et.param2} AND START_TIME <= DATE_ADD(STR_TO_DATE(#{et.param3}, '%Y-%m-%d'), INTERVAL 1 DAY) ORDER BY START_TIME; ";
                        java.util.List<JSONObject> entities=iBzSysWeekliesDefaultService.select(strSql,param);//SQL调用
                            if(entities.size()>0){
                            JSONObject entity=entities.get(0);
                                    cn.ibizlab.crm.core.crm.domain.task targetEntity =new cn.ibizlab.crm.core.crm.domain.task();
                                    for (Map.Entry entry : entity.entrySet()) {
                                    targetEntity.set(String.valueOf(entry.getKey()),entry.getValue());
                                    }
                                    org.springframework.cglib.beans.BeanCopier copier= org.springframework.cglib.beans.BeanCopier.create(targetEntity.getClass(),weekliesopendetail2activities.getClass(), false);
                                    copier.copy(targetEntity,weekliesopendetail2activities,null);
                            }
                        update(weekliesopendetail2default);//更新fact中变量值
                        update(weekliesopendetail2activities);//更新fact中变量值
                        update(weekliesopendetail2notes);//更新fact中变量值
                        update(weekliesopendetail2tasks);//更新fact中变量值
            end

            //逻辑处理节点[本周进展评估]
            rule "rawsqlcall2"
            ruleflow-group "weekliesopendetail2rawsqlcall2"
            when
            then
    Map param =new HashMap();
        param.put("param0",weekliesopendetail2default.get("createman"));
        param.put("param1",weekliesopendetail2default.get("owner"));
        param.put("param2",weekliesopendetail2default.get("createman"));
        param.put("param3",weekliesopendetail2default.get("owner"));
        param.put("param4",weekliesopendetail2default.get("createman"));
        param.put("param5",weekliesopendetail2default.get("owner"));
        param.put("param6",weekliesopendetail2default.get("createman"));
        param.put("param7",weekliesopendetail2default.get("owner"));
        param.put("param8",weekliesopendetail2default.get("startdate"));
        param.put("param9",weekliesopendetail2default.get("enddate"));
    String strSql="SELECT T1.* FROM ( select t1.id,t1.principal_type,t1.principal_name,t1.update_time,t1.principal_id,t1.content,t1.create_man from note_attach t1,task t2 where t1.PRINCIPAL_TYPE = 'TASK' and t1.principal_id = t2.id and (t1.CREATE_MAN = #{et.param0} or EXISTS (SELECT 1 FROM task_executor T21 WHERE T21.TASK_ID = T1.PRINCIPAL_ID AND T21.USER_ID = #{et.param1})) UNION ALL select t1.id,t1.principal_type,CONCAT('（',t3.account_name,'）',t1.principal_name) as principal_name,t1.update_time,t1.principal_id,t1.content,t1.create_man from note_attach t1,project t2,account t3 where t1.PRINCIPAL_TYPE = 'PROJECT' and t1.principal_id = t2.id and t2.account_id = t3.id and (t1.CREATE_MAN = #{et.param2} or EXISTS (SELECT 1 FROM executor T31 WHERE T31.PRINCIPAL_ID = T1.PRINCIPAL_ID AND T31.USER_ID = #{et.param3})) UNION ALL select t1.id,t1.principal_type,CONCAT('（',t3.account_name,'）',t1.principal_name) as principal_name,t1.update_time,t1.principal_id,t1.content,t1.create_man from note_attach t1,lead t2,account t3 where t1.PRINCIPAL_TYPE = 'LEAD' and t1.principal_id = t2.id and t2.account_id = t3.id and (t1.CREATE_MAN = #{et.param4} or EXISTS (SELECT 1 FROM executor T31 WHERE T31.PRINCIPAL_ID = T1.PRINCIPAL_ID AND T31.USER_ID = #{et.param5})) UNION ALL select t1.id,t1.principal_type,CONCAT('（',t3.account_name,'）',t1.principal_name) as principal_name,t1.update_time,t1.principal_id,t1.content,t1.create_man from note_attach t1,deal t2,account t3 where t1.PRINCIPAL_TYPE = 'DEAL' and t1.principal_id = t2.id and t2.account_id = t3.id and (t1.CREATE_MAN = #{et.param6} or EXISTS (SELECT 1 FROM executor T31 WHERE T31.PRINCIPAL_ID = T1.PRINCIPAL_ID AND T31.USER_ID = #{et.param7})) ) T1 WHERE T1.UPDATE_TIME >= #{et.param8} AND T1.UPDATE_TIME <= DATE_ADD(STR_TO_DATE(#{et.param9}, '%Y-%m-%d'), INTERVAL 1 DAY) ORDER BY T1.principal_name,T1.UPDATE_TIME";
                        java.util.List<JSONObject> entities=iBzSysWeekliesDefaultService.select(strSql,param);//SQL调用
                            if(entities.size()>0){
                            JSONObject entity=entities.get(0);
                                    cn.ibizlab.crm.core.crm.domain.note_attach targetEntity =new cn.ibizlab.crm.core.crm.domain.note_attach();
                                    for (Map.Entry entry : entity.entrySet()) {
                                    targetEntity.set(String.valueOf(entry.getKey()),entry.getValue());
                                    }
                                    org.springframework.cglib.beans.BeanCopier copier= org.springframework.cglib.beans.BeanCopier.create(targetEntity.getClass(),weekliesopendetail2notes.getClass(), false);
                                    copier.copy(targetEntity,weekliesopendetail2notes,null);
                            }
                        update(weekliesopendetail2default);//更新fact中变量值
                        update(weekliesopendetail2activities);//更新fact中变量值
                        update(weekliesopendetail2notes);//更新fact中变量值
                        update(weekliesopendetail2tasks);//更新fact中变量值
            end

            //逻辑处理节点[下周计划]
            rule "rawsqlcall3"
            ruleflow-group "weekliesopendetail2rawsqlcall3"
            when
            then
    Map param =new HashMap();
        param.put("param0",weekliesopendetail2default.get("owner"));
        param.put("param1",weekliesopendetail2default.get("startdate"));
        param.put("param2",weekliesopendetail2default.get("startdate"));
        param.put("param3",weekliesopendetail2default.get("startdate"));
        param.put("param4",weekliesopendetail2default.get("startdate"));
    String strSql="SELECT       ID as TARGET_ID,       SUBJECT as NAME,       'TASK' as TARGET_TYPE,     PRIORITY,     STATUS,     DUE_DATE,     DESCRIPTION FROM       TASK  T1 WHERE       T1.`TYPE` = 'TASK'       AND EXISTS (SELECT 1 FROM task_executor T2 WHERE T2.TASK_ID = T1.ID AND T2.USER_ID = #{et.param0})       		AND T1.DUE_DATE >=  DATE_ADD(#{et.param1} + INTERVAL (7-WEEKDAY(#{et.param2})) DAY, INTERVAL 0 DAY) 		AND T1.DUE_DATE <= DATE_ADD(#{et.param3}, INTERVAL (13-WEEKDAY(#{et.param4})) DAY)     ORDER BY T1.DUE_DATE";
                        java.util.List<JSONObject> entities=iBzSysWeekliesDefaultService.select(strSql,param);//SQL调用
                            if(entities.size()>0){
                            JSONObject entity=entities.get(0);
                                    cn.ibizlab.crm.core.crm.domain.task targetEntity =new cn.ibizlab.crm.core.crm.domain.task();
                                    for (Map.Entry entry : entity.entrySet()) {
                                    targetEntity.set(String.valueOf(entry.getKey()),entry.getValue());
                                    }
                                    org.springframework.cglib.beans.BeanCopier copier= org.springframework.cglib.beans.BeanCopier.create(targetEntity.getClass(),weekliesopendetail2tasks.getClass(), false);
                                    copier.copy(targetEntity,weekliesopendetail2tasks,null);
                            }
                        update(weekliesopendetail2default);//更新fact中变量值
                        update(weekliesopendetail2activities);//更新fact中变量值
                        update(weekliesopendetail2notes);//更新fact中变量值
                        update(weekliesopendetail2tasks);//更新fact中变量值
            end

            //逻辑处理节点[填充数据]
            rule "prepareparam2"
            ruleflow-group "weekliesopendetail2prepareparam2"
            when
            then
                            weekliesopendetail2default.set("activities",weekliesopendetail2activities.get(""));
                            weekliesopendetail2default.set("tasks",weekliesopendetail2tasks.get(""));
                            weekliesopendetail2default.set("notes",weekliesopendetail2notes.get(""));
                        update(weekliesopendetail2default);//更新fact中变量值
                        update(weekliesopendetail2activities);//更新fact中变量值
                        update(weekliesopendetail2notes);//更新fact中变量值
                        update(weekliesopendetail2tasks);//更新fact中变量值
            end